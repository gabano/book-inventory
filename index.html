<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Acervo - Estável</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; font-family: sans-serif; margin: 0; padding-bottom: 50px; }
        /* Garante que o container de vídeo seja único e limpo */
        #interactive { 
            width: 100%; 
            height: 280px; 
            background: #000; 
            position: relative; 
            border-bottom: 5px solid #28a745;
        }
        #interactive video, #interactive canvas { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: cover; 
        }
        .laser { 
            position: absolute; top: 50%; left: 0; right: 0; 
            height: 2px; background: red; z-index: 10; 
            box-shadow: 0 0 8px red; animation: move 2s infinite; 
        }
        @keyframes move { 0%, 100% { top: 30%; } 50% { top: 70%; } }
        
        .app-body { padding: 20px; margin-top: -20px; background: white; border-radius: 25px 25px 0 0; position: relative; z-index: 100; }
        .status-box { padding: 10px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 0.8rem; }
        .waiting { background: #f8f9fa; color: #666; border: 1px solid #ddd; }
        .detected { background: #d4edda; color: #155724; border: 1px solid #28a745; }
        
        .form-input { border: none; background: #f1f3f5; border-radius: 12px; padding: 12px; margin-bottom: 10px; width: 100%; font-weight: 500; }
        .btn-save { background: #28a745; color: white; border: none; border-radius: 15px; padding: 15px; font-weight: bold; width: 100%; }
        .btn-cam { font-size: 0.7rem; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="interactive">
    <div class="laser"></div>
</div>

<div class="app-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <button class="btn btn-outline-dark btn-sm btn-cam" onclick="toggleCamera()">Inverter Câmera</button>
        <button class="btn btn-outline-danger btn-sm btn-cam" onclick="location.reload()">Reiniciar App</button>
    </div>

    <div id="statusTag" class="status-box waiting">AGUARDANDO LEITURA...</div>

    <input type="text" id="isbn" class="form-input fw-bold" readonly placeholder="ISBN">
    <input type="text" id="titulo" class="form-input" placeholder="Título do Livro">
    <input type="text" id="autor" class="form-input" placeholder="Autor">
    <input type="text" id="ano" class="form-input" placeholder="Ano">

    <div class="d-flex flex-wrap gap-2 mb-3">
        <input type="checkbox" class="btn-check" id="y6" value="Y6"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y6">Y6</label>
        <input type="checkbox" class="btn-check" id="y7" value="Y7"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y7">Y7</label>
        <input type="checkbox" class="btn-check" id="y8" value="Y8"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y8">Y8</label>
        <input type="checkbox" class="btn-check" id="y9" value="Y9"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y9">Y9</label>
    </div>

    <button class="btn-save shadow" onclick="saveData()">SALVAR REGISTRO</button>
    
    <div class="mt-4 p-3 bg-dark text-white rounded-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small fw-bold">ACUMULADO CSV</span>
            <button class="btn btn-primary btn-sm" onclick="downloadExcel()">BAIXAR EXCEL</button>
        </div>
        <div id="csvPreview" style="font-size: 0.6rem; font-family: monospace; opacity: 0.7; overflow-x: auto;"></div>
    </div>
</div>

<script>
    let inventory = [];
    let isPaused = false;
    let useTraseira = true;

    async function initScanner() {
        // Limpeza profunda: remove qualquer elemento de vídeo ou canvas residual
        const container = document.querySelector("#interactive");
        const oldVideo = container.querySelector("video");
        const oldCanvas = container.querySelector("canvas");
        if (oldVideo) oldVideo.remove();
        if (oldCanvas) oldCanvas.remove();

        try {
            await Quagga.stop();
        } catch(e) {}

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: "#interactive",
                constraints: {
                    facingMode: useTraseira ? "environment" : "user",
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
            },
            decoder: { readers: ["ean_reader", "code_128_reader"] },
            locate: true
        }, function(err) {
            if (err) {
                console.error(err);
                document.getElementById('statusTag').innerText = "ERRO: ACESSO À CÂMERA NEGADO";
                return;
            }
            Quagga.start();
        });
    }

    function toggleCamera() {
        useTraseira = !useTraseira;
        initScanner();
    }

    Quagga.onDetected(data => {
        if (!isPaused) {
            isPaused = true;
            const code = data.codeResult.code;
            document.getElementById('isbn').value = code;
            document.getElementById('statusTag').innerText = "BUSCANDO DADOS...";
            document.getElementById('statusTag').className = "status-box detected";
            if (navigator.vibrate) navigator.vibrate(100);
            fetchBook(code);
        }
    });

    async function fetchBook(isbn) {
        try {
            // Tentativa prioritária em Português
            let res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&hl=pt-BR`);
            let data = await res.json();
            
            if (!data.items) {
                // Segunda tentativa: busca geral
                res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${isbn}&hl=pt-BR`);
                data = await res.json();
            }

            if (data.items) {
                const info = data.items[0].volumeInfo;
                document.getElementById('titulo').value = info.title || "";
                document.getElementById('autor').value = info.authors ? info.authors.join(", ") : "";
                document.getElementById('ano').value = info.publishedDate ? info.publishedDate.substring(0,4) : "";
            }
        } catch(e) {}
    }

    function saveData() {
        const isbn = document.getElementById('isbn').value;
        const titulo = document.getElementById('titulo').value;
        if (!isbn || !titulo) { alert("Obrigatório: ISBN e Título"); return; }

        const series = Array.from(document.querySelectorAll('.btn-check:checked')).map(c => c.value).join(", ");
        
        inventory.push({ 
            ISBN: isbn, Titulo: titulo, Autor: document.getElementById('autor').value, 
            Ano: document.getElementById('ano').value, Serie: series || "Nenhuma", Quantidade: 1 
        });

        updateLog();
        resetForm();
    }

    function updateLog() {
        const preview = document.getElementById('csvPreview');
        let txt = "ISBN;TITULO;SÉRIE";
        inventory.slice().reverse().forEach(i => {
            txt += `<br>${i.ISBN}; ${i.Titulo.substring(0,15)}; ${i.Serie}`;
        });
        preview.innerHTML = txt;
    }

    function resetForm() {
        document.getElementById('isbn').value = "";
        document.getElementById('titulo').value = "";
        document.getElementById('autor').value = "";
        document.getElementById('ano').value = "";
        document.querySelectorAll('.btn-check').forEach(c => c.checked = false);
        document.getElementById('statusTag').innerText = "AGUARDANDO LEITURA...";
        document.getElementById('statusTag').className = "status-box waiting";
        isPaused = false;
    }

    function downloadExcel() {
        const ws = XLSX.utils.json_to_sheet(inventory);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Books");
        XLSX.writeFile(wb, "books_db.xlsx");
    }

    // Inicialização automática
    window.onload = initScanner;
</script>
</body>
</html>
