<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Acervo Mobile V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, sans-serif; }
        #interactive { width: 100%; height: 280px; border-radius: 0 0 25px 25px; background: #000; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .laser { position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: rgba(255, 0, 0, 0.7); box-shadow: 0 0 8px red; z-index: 10; animation: move 2s infinite; }
        @keyframes move { 0%, 100% { top: 30%; } 50% { top: 70%; } }
        .info-card { background: white; border-radius: 20px; padding: 20px; margin-top: -30px; position: relative; z-index: 20; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .status-banner { font-size: 0.8rem; font-weight: 800; padding: 10px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .status-waiting { background: #fff3cd; color: #856404; }
        .status-detected { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .form-control-custom { border: none; background: #f1f3f5; border-radius: 12px; padding: 12px; margin-bottom: 10px; font-weight: 500; width: 100%; }
        .btn-save { background: #28a745; color: white; border: none; border-radius: 15px; padding: 15px; font-weight: bold; width: 100%; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
        .export-section { background: #343a40; color: white; border-radius: 20px; padding: 20px; margin: 20px 10px; }
        #csvPreview { font-family: monospace; font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>

<div id="interactive"><div class="laser"></div></div>

<div class="container" style="max-width: 500px;">
    <div class="p-2"><select id="camList" class="form-select form-select-sm border-0 shadow-sm" onchange="startCam()"></select></div>

    <div class="info-card">
        <div id="statusTag" class="status-banner status-waiting">Aguardando Código...</div>
        
        <input type="text" id="isbn" class="form-control-custom fw-bold" readonly placeholder="ISBN">
        <input type="text" id="titulo" class="form-control-custom" placeholder="Título (Obrigatório)">
        <input type="text" id="autor" class="form-control-custom" placeholder="Autor">
        <input type="text" id="ano" class="form-control-custom" placeholder="Ano">

        <div class="d-flex flex-wrap gap-2 mb-3 mt-1">
            <input type="checkbox" class="btn-check" id="y6" value="Y6"><label class="btn btn-outline-secondary btn-sm rounded-pill" for="y6">Y6</label>
            <input type="checkbox" class="btn-check" id="y7" value="Y7"><label class="btn btn-outline-secondary btn-sm rounded-pill" for="y7">Y7</label>
            <input type="checkbox" class="btn-check" id="y8" value="Y8"><label class="btn btn-outline-secondary btn-sm rounded-pill" for="y8">Y8</label>
            <input type="checkbox" class="btn-check" id="y9" value="Y9"><label class="btn btn-outline-secondary btn-sm rounded-pill" for="y9">Y9</label>
        </div>

        <button class="btn-save" onclick="saveData()">ADICIONAR LIVRO</button>
    </div>

    <div class="export-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="m-0 fw-bold">Registro CSV</h6>
            <button class="btn btn-primary btn-sm rounded-pill" onclick="downloadExcel()">BAIXAR EXCEL</button>
        </div>
        <div id="csvPreview">ISBN;Titulo;Qtd</div>
    </div>
</div>

<script>
    let inventory = [];
    let isPaused = false;

    navigator.mediaDevices.enumerateDevices().then(devices => {
        const list = document.getElementById('camList');
        devices.filter(d => d.kind === 'videoinput').forEach(d => {
            let opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || 'Câmera ' + (list.length + 1);
            list.appendChild(opt);
        });
        if (list.length > 0) startCam();
    });

    function startCam() {
        Quagga.init({
            inputStream: { name: "Live", target: "#interactive", constraints: { deviceId: document.getElementById('camList').value, facingMode: "environment" } },
            decoder: { readers: ["ean_reader", "code_128_reader"] },
            locate: true
        }, (err) => { if (!err) Quagga.start(); });
    }

    Quagga.onDetected(data => {
        if (!isPaused) {
            isPaused = true;
            const code = data.codeResult.code.trim();
            document.getElementById('isbn').value = code;
            document.getElementById('statusTag').innerText = "BUSCANDO DADOS...";
            document.getElementById('statusTag').className = "status-banner status-detected";
            if (navigator.vibrate) navigator.vibrate(100);
            fetchBook(code);
        }
    });

    async function fetchBook(isbn) {
        // Limpa campos antes da nova busca
        document.getElementById('titulo').value = "Buscando...";
        document.getElementById('autor').value = "";
        document.getElementById('ano').value = "";

        try {
            // TENTATIVA 1: Busca exata por ISBN com preferência para PT-BR
            let response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&hl=pt-BR`);
            let data = await response.json();

            // TENTATIVA 2: Se não vier nada, busca geral (alguns livros não estão indexados como ISBN puro)
            if (!data.items) {
                response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${isbn}&hl=pt-BR`);
                data = await response.json();
            }

            if (data.items) {
                const info = data.items[0].volumeInfo;
                document.getElementById('titulo').value = info.title || "";
                document.getElementById('autor').value = info.authors ? info.authors.join(", ") : "";
                document.getElementById('ano').value = info.publishedDate ? info.publishedDate.substring(0,4) : "";
                document.getElementById('statusTag').innerText = "LIVRO ENCONTRADO!";
            } else {
                document.getElementById('titulo').value = "";
                document.getElementById('statusTag').innerText = "NÃO ENCONTRADO (DIGITE O TÍTULO)";
            }
        } catch(e) {
            document.getElementById('titulo').value = "";
            document.getElementById('statusTag').innerText = "ERRO DE CONEXÃO (DIGITE MANUAL)";
        }
    }

    function saveData() {
        const isbn = document.getElementById('isbn').value;
        const titulo = document.getElementById('titulo').value;
        if (!isbn || !titulo || titulo === "Buscando...") { alert("ISBN e Título são obrigatórios!"); return; }

        const series = Array.from(document.querySelectorAll('.btn-check:checked')).map(c => c.value).join(", ");
        const idx = inventory.findIndex(i => i.ISBN === isbn && i.Serie === series);
        
        if (idx > -1) { inventory[idx].Quantidade += 1; }
        else {
            inventory.push({ 
                ISBN: isbn, Titulo: titulo, Autor: document.getElementById('autor').value, 
                Ano: document.getElementById('ano').value, Serie: series || "Nenhuma", Quantidade: 1 
            });
        }
        updateLog();
        resetForm();
    }

    function updateLog() {
        const preview = document.getElementById('csvPreview');
        let txt = "ISBN;Titulo;Qtd";
        inventory.slice().reverse().forEach(i => {
            txt += `<br>${i.ISBN}; ${i.Titulo.substring(0,20)}; Qtd:${i.Quantidade}`;
        });
        preview.innerHTML = txt;
    }

    function resetForm() {
        document.getElementById('isbn').value = "";
        document.getElementById('titulo').value = "";
        document.getElementById('autor').value = "";
        document.getElementById('ano').value = "";
        document.querySelectorAll('.btn-check').forEach(c => c.checked = false);
        document.getElementById('statusTag').innerText = "Aguardando Código...";
        document.getElementById('statusTag').className = "status-banner status-waiting";
        isPaused = false;
    }

    function downloadExcel() {
        const ws = XLSX.utils.json_to_sheet(inventory);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventario");
        XLSX.writeFile(wb, "books_db.xlsx");
    }
</script>
</body>
</html>
