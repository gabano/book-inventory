<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Mobile Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4a90e2; --success-color: #2ecc71; --warning-color: #f1c40f; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        
        /* Container da Câmera estilo App */
        #interactive { 
            width: 100%; 
            height: 250px; 
            border-radius: 20px; 
            background: #000; 
            overflow: hidden; 
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 4px solid #fff;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Mira do Scanner */
        .scanner-laser {
            position: absolute;
            top: 50%; left: 10%; right: 10%;
            height: 2px; background: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 10px red;
            z-index: 10;
            animation: scanning 2s infinite;
        }
        @keyframes scanning { 0% { top: 20%; } 50% { top: 80%; } 100% { top: 20%; } }

        /* Estilização dos Cards */
        .app-card { background: #fff; border-radius: 25px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .status-badge { 
            font-size: 0.9rem; padding: 8px 15px; border-radius: 50px; font-weight: 600; 
            text-align: center; margin-bottom: 15px; display: block;
        }
        .status-wait { background: #fef9e7; color: #996515; }
        .status-done { background: #e8f8f5; color: #117a65; }

        /* Botões Mobile */
        .btn-main { border-radius: 15px; padding: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .log-preview { font-size: 0.75rem; color: #7f8c8d; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>

<div class="container py-3">
    <div class="app-card text-center">
        <h5 class="fw-bold mb-3">Escaneie o Código</h5>
        <div id="interactive">
            <div class="scanner-laser"></div>
        </div>
        <div class="mt-3">
            <select id="camList" class="form-select border-0 bg-light rounded-pill" onchange="startCam()"></select>
        </div>
    </div>

    <div class="app-card">
        <span id="statusLabel" class="status-badge status-wait">AGUARDANDO LEITURA...</span>
        
        <div class="row g-2">
            <div class="col-12">
                <input type="text" id="isbn" class="form-control bg-light border-0 py-3 rounded-4 fw-bold" placeholder="ISBN" readonly>
            </div>
            <div class="col-12">
                <input type="text" id="titulo" class="form-control border-0 bg-light py-3 rounded-4" placeholder="Título do Livro">
            </div>
            <div class="col-6">
                <input type="text" id="autor" class="form-control border-0 bg-light py-3 rounded-4" placeholder="Autor">
            </div>
            <div class="col-6">
                <input type="text" id="ano" class="form-control border-0 bg-light py-3 rounded-4" placeholder="Ano">
            </div>
        </div>

        <div class="my-3 p-3 bg-light rounded-4">
            <small class="fw-bold d-block mb-2 text-muted">Série:</small>
            <div class="d-flex flex-wrap gap-2">
                <input type="checkbox" class="btn-check" id="y6" value="Y6"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y6">Y6</label>
                <input type="checkbox" class="btn-check" id="y7" value="Y7"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y7">Y7</label>
                <input type="checkbox" class="btn-check" id="y8" value="Y8"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y8">Y8</label>
                <input type="checkbox" class="btn-check" id="y9" value="Y9"><label class="btn btn-outline-primary btn-sm rounded-pill" for="y9">Y9</label>
                <input type="checkbox" class="btn-check" id="ou" value="Outros"><label class="btn btn-outline-primary btn-sm rounded-pill" for="ou">Outros</label>
            </div>
        </div>

        <button class="btn btn-success btn-main w-100 mb-2" onclick="saveData()">Salvar Registro</button>
        <button class="btn btn-primary btn-main w-100 mb-2" onclick="downloadExcel()">Baixar Planilha</button>
    </div>

    <div class="app-card">
        <h6 class="fw-bold mb-2">Últimos Registros (CSV)</h6>
        <div id="csvPreview" class="log-preview" style="max-height: 100px; overflow-y: auto;">ISBN;Titulo;Qtd</div>
    </div>
</div>

<script>
    let inventory = [];
    let isPaused = false;

    navigator.mediaDevices.enumerateDevices().then(devices => {
        const list = document.getElementById('camList');
        devices.filter(d => d.kind === 'videoinput').forEach(d => {
            let opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || 'Câmera ' + (list.length + 1);
            list.appendChild(opt);
        });
        if (list.length > 0) startCam();
    });

    function startCam() {
        Quagga.init({
            inputStream: { 
                type: "LiveStream", 
                target: "#interactive",
                constraints: { 
                    deviceId: document.getElementById('camList').value,
                    width: { min: 640 },
                    height: { min: 480 },
                    facingMode: "environment" // Prioriza câmera traseira
                }
            },
            decoder: { readers: ["ean_reader", "code_128_reader"] },
            locate: true // Ajuda a encontrar o código em imagens ruidosas
        }, (err) => { if (!err) Quagga.start(); });
    }

    Quagga.onDetected(data => {
        if (!isPaused) {
            isPaused = true;
            const code = data.codeResult.code;
            document.getElementById('isbn').value = code;
            document.getElementById('statusLabel').innerText = "LEITURA REALIZADA!";
            document.getElementById('statusLabel').className = "status-badge status-done";
            fetchBook(code);
        }
    });

    async function fetchBook(isbn) {
        try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&hl=pt-BR`);
            const json = await res.json();
            if (json.items) {
                const info = json.items[0].volumeInfo;
                document.getElementById('titulo').value = info.title || "";
                document.getElementById('autor').value = info.authors ? info.authors.join(", ") : "";
                document.getElementById('ano').value = info.publishedDate ? info.publishedDate.substring(0,4) : "";
            }
        } catch(e) {}
    }

    function saveData() {
        const isbn = document.getElementById('isbn').value;
        const titulo = document.getElementById('titulo').value;
        const series = Array.from(document.querySelectorAll('.btn-check:checked')).map(c => c.value).join(", ");

        if (!isbn || !titulo) { alert("Escaneie um livro e digite o título!"); return; }

        const idx = inventory.findIndex(i => i.ISBN === isbn && i.Serie === series);
        if (idx > -1) { inventory[idx].Quantidade += 1; }
        else {
            inventory.push({ 
                ISBN: isbn, Titulo: titulo, Autor: document.getElementById('autor').value, 
                Ano: document.getElementById('ano').value, Serie: series || "Nenhuma", Quantidade: 1 
            });
        }
        updateLog();
        resetForm();
    }

    function updateLog() {
        const preview = document.getElementById('csvPreview');
        let txt = "ISBN;Titulo;Qtd";
        inventory.slice(-5).reverse().forEach(i => {
            txt += `<br>${i.ISBN}; ${i.Titulo.substring(0,15)}...; ${i.Quantidade}`;
        });
        preview.innerHTML = txt;
    }

    function resetForm() {
        document.getElementById('isbn').value = "";
        document.getElementById('titulo').value = "";
        document.getElementById('autor').value = "";
        document.getElementById('ano').value = "";
        document.querySelectorAll('.btn-check').forEach(c => c.checked = false);
        document.getElementById('statusLabel').innerText = "AGUARDANDO LEITURA...";
        document.getElementById('statusLabel').className = "status-badge status-wait";
        isPaused = false;
    }

    function downloadExcel() {
        const ws = XLSX.utils.json_to_sheet(inventory);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventario");
        XLSX.writeFile(wb, "books_db.xlsx");
    }
</script>
</body>
</html>
